{{> layout/header}}

<div class="container p-5">
    <div class="card">
        <div class="card-header mb-0">
            <h4><b>포인트충전</b></h4>
        </div>
        <div class="card-body">
            <div>
                <label class="form-label fw-bold">현재 보유 포인트</label>
                <div class="mb-4">
                    <span class="badge bg-primary fs-5">{{user.point}} P</span>
                </div>
            </div>
            <hr/>
            <div class="mb-4">
                <label class="form-label fw-bold">충전할 포인트 선택</label>
                <!-- row 가로 정렬(12등분 법칙 적용)-->
                <div class="row g-3">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="1000">1,000P</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="5000">5,000P</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="0000">10,000P</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="20000">20,000P</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="50000">50,000P</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 point-btn" data-amount="100000">100,000P</button>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">충전 예정 금액</label>
                <p class="form-control-plaintext"><span class="badge bg-success fs-5" id="selectedAmount">0</span> P</p>
            </div>

            <!-- d-grid (자식 속성을 가로 너비를 꽉 채우게 한다.)-->
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="chargeBtn" disabled>충전하기</button>
                <a href="/user/detail" class="btn btn-secondary">취소</a>
            </div>

        </div>
    </div>
</div>

{{> layout/footer}}
<!-- 포트원 js 용 sdk 선언 -->
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. 주요 변수 선언
        const impkey = 'imp23703003';
        let selectedAmount = 0; // 사용자가 선택한 버튼에 금액 정보를 담을 변수;

        // 필요한 DOM Element 자바 스크립트로 가져오기 $ - dom 엘리먼트라는 것을 관행적으로 표시함
        const $btns = document.querySelectorAll('.point-btn'); // 금액 버튼들
        const $displayAmount = document.getElementById('selectedAmount');
        const $chargeBtn = document.getElementById('chargeBtn');

        // 화면 업데이트 함수 선언(충전할 예정 금액)
        function updateAmount(amount) {
            selectedAmount = amount;
            $displayAmount.textContent = amount.toLocaleString();

            if (amount > 0) {
                $chargeBtn.disabled = false;
            } else {
                $chargeBtn.disabled = true;
            }
        }

        // 2. 금액 버튼들에 이벤트 리스너 등록 및 이벤트 핸들러 처리
        $btns.forEach(btn => {
            btn.addEventListener('click', function () {
                $btns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const amount = parseInt(this.getAttribute('data-amount'));
                updateAmount(amount);
            });
        });

        $chargeBtn.addEventListener('click', function () {
            // 1. 결제 사전 준비
            // 우리 서버에 이 금액으로 주문번호(merchant_uid) 를 만들어 줘서 요청함
            // 이유 : 보안을 위해 주문번호는 반드시 백엔드 에서 생성해야함
            fetch("/api/payment/prepare", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({amount: selectedAmount})
            }).then(res => {
                if (!res.ok) {
                    throw Error("주문번호 생성 실패");
                }
                return res.json(); // json 문자열을 js Object 파싱 처리
            }).then(data => {
                console.log('data object 확인: ' + data.amount);
                const merchantUid = data.merchant_uid;
                const IMP = window.IMP;
                IMP.init("imp23703003");
                IMP.request_pay(
                        {
                            channelKey: "channel-key-2ea7fea6-2f5a-4560-baad-46eb93136971",
                            pay_method: "card",
                            merchant_uid: merchantUid, // 주문 고유 번호
                            name: "포인트 충전", // 결제창에 뜰 상품명
                            amount: selectedAmount,
                            buyer_email: "{{user.email}}",
                            buyer_name: "{{user.username}}",
                        },
                        function (response) {
                            if (response.success) {
                                // 확인하는 과정이 필요함
                                verifyPayment(response.imp_uid, response.merchant_uid);
                            } else {
                                alert("결제 실패 \n에러내용" + response.err_msg);
                            }
                        },
                );
            }).catch(err => {
                alert(err.message);
            });
        });

        // 5. 서버 검증 함수(최종 승인)
        //----------------------------------------
        function verifyPayment(imp_uid, merchant_uid) {
            fetch('/api/payment/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    impUid: imp_uid,
                    merchantUid: merchant_uid
                })
            }).then(res => {
                if (!res.ok) {
                    return res.json().then((e) => {
                        throw new Error(e.message);
                    });
                }
                //성공

                // 상자를 뜯어서 js Object로 변환
                return res.json();
            }).then(data => {
                // 모든 검증 통과 (포인트 충전 완료)
                alert(`충전이 완료되었습니다.\n 충전된 금액: ${data.amount}\n 현재 포인트 : ${data.currentPoint}`);
                location.href = '/user/detail';
            }).catch(err => {
                alert('결제 검증에 실패했습니다.\n 관리자에게 문의')
            })
        }

    });


</script>
