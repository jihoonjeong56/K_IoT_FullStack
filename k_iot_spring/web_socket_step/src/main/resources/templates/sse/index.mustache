<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 20px;
            background-color: #f5f5f5;
            font-family: sans-serif;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 500px;
            height: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);

            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: #375fa3;
            color: white;
            text-align: center;
            padding: 15px;
        }

        .chat-box {
            flex: 1;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
        }

        .msg-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .name {
            font-size: 12px;
            color: #a5a8b5;
            margin-bottom: 5px;
        }

        .msg {
            background-color: #e9e8eb;
            padding: 10px 15px;
            border-radius: 15px;
            border-top-left-radius: 0;
            font-size: 14px;
            max-width: 80%;
            color: #181930;
            white-space: pre-wrap;
        }

        .input-area {
            background-color: #f0f1f5;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .input-sender {
            width: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .input-msg {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .btn-send {
            background-color: #3c5999;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h3>채팅방(SSE)</h3>
        <p>실시간 채팅 - 푸쉬서버</p>
    </div>
    <div class="chat-box" id="chatBox">
        {{#chatList}}
            <div class="msg-wrap">
                <div class="msg-box">
                    <span class="name">{{sender}}</span>
                    <span class="msg">{{message}}</span>
                </div>
            </div>
        {{/chatList}}
    </div>
    <form id="chatForm" class="input-area">
        <input type="text" id="sender" name="sender" value="익명" class="input-sender" required>
        <input type="text" id="message" name="message" placeholder="내용 입력..." class="input-msg" autofocus>
        <button type="submit" class="btn-send">전송</button>
    </form>
</div>

<script>
    <!--  3초마다 서버에 새로운 데이터가 있나 요청하는 방식 -->
    // 1. 화면에 스크롤 바닥 고정
    const chatBox = document.getElementById("chatBox");
    // chatBox.scrollTop = 0; // 스크롤 최상단

    const chatForm = document.getElementById("chatForm");

    // 2. SSE 연결 설정
    // - EventSource js API (SSE 처리하기 위해 제공)
    // 하나의 논리적인 연결 지속되는 선을 요청
    // /sse/connect: 서버 측과 클라이언트 간의 약속
    const eventSource = new EventSource("/sse/connect");
    eventSource.onopen = () => console.log("SSE 연결 성공");
    eventSource.onerror = () => console.log("SSE 연결 실패");
    window.addEventListener("beforeunload", () => {
        eventSource.close();
    }); // 페이지 종료시 연결 종료

    eventSource.addEventListener('newMessage', (event) => {
        // 데이터 형식: "Sender: Message"
        // const rawData = event.data;
        // alert("rawData: " + rawData);

        const rawData = event.data;
        const separatorIndex = rawData.indexOf(":"); // : 의 인덱스 번호
        let sender = "익명";
        let message = rawData;
        if(separatorIndex !== -1) {
            sender = rawData.substring(0, separatorIndex);
            message = rawData.substring(separatorIndex + 1);
        }

        // DOM 요소 생성
        const msgWrap = document.createElement("div");
        msgWrap.className = "msg-wrap";

        const msgBox = document.createElement("div");
        msgBox.className = "msg-box";

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = sender;

        const msgSpan = document.createElement("span");
        msgSpan.className = "msg";
        msgSpan.textContent = message;

        msgBox.appendChild(nameSpan);
        msgBox.appendChild(msgSpan);
        msgWrap.appendChild(msgBox);

        // 채팅창에 요소 추가
        chatBox.appendChild(msgWrap);

        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // form 기본 이벤트 제거
    chatForm.addEventListener("submit", function (e) {
        e.preventDefault(); // 기본 submit 이벤트 방지 (새로고침 방지)

        const senderInput = document.getElementById("sender");
        const messageInput = document.getElementById("message");

        const sender = senderInput.value;
        const message = messageInput.value;

        if(!message.trim()) {
            alert("메세지는 반드시 입력해주세요");
            return;
        }

        // fetch 비동기 통신 처리
        fetch("/sse/send", {
            method: "POST",
            headers: {
                "Content-Type" : "application/x-www-form-urlencoded"
            },
            // 폼 데이터 형식으로 변환 key=value 로 변환 ---> sender="홍길동"&message="..."
            body: new URLSearchParams({
                sender: sender,
                message: message
            })
        })
                .then(res => {
                    if(res.ok) {
                        messageInput.value = "";
                        messageInput.focus();
                    } else {
                        console.log("전송 실패");
                    }
                })
                .catch(err => console.log("에러 발생: ", err));


    });
</script>
</body>
</html>